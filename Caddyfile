{
  # Global options block. Uncomment for debugging:
  # debug
}

{$APP_DOMAIN} {
  encode zstd gzip
  @api path /socket.io/* /api/* *
  reverse_proxy backend:4000

  # Basic security headers
  header {
    Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    X-Frame-Options DENY
    X-Content-Type-Options nosniff
    Referrer-Policy no-referrer-when-downgrade
    Content-Security-Policy "default-src 'self' * data: blob: 'unsafe-inline' 'unsafe-eval'"
  }
  log {
    output stdout
    format console
  }
}

# Fallback if APP_DOMAIN not set: serve on any host header (useful in first boot). Comment out in prod.
:80 {
  respond "APP_DOMAIN not configured: set APP_DOMAIN env for Caddy" 200
}
